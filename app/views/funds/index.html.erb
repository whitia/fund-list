<% provide :title, 'Organize' %>
<div class="container my-5">
  <h2>Organize</h2>
  <div class="font-weight-light">
    <p>
      You can organize your investments for SBI SECURITIES Co.,Ltd. in Organize, following next section and let's beginning.<br />
      Do you necessary more help? You may be able to find solution in <%= link_to 'Help', help_path %>.
    </p>
    <ol>
      <li>Import a CSV file of your investments.</li>
      <li>Choose "Class" of assets in dropdown list.</li>
      <li>Confirm real ratios to chart or pie.</li>
      <li>Input "Ideal" ratios on textbox.</li>
      <li>Input "Increase" on textbox if increase an investment.</li>
    </ol>
  </div>

  <div class="row my-5">
    <div class="col-xs-12 col-sm-12">
      <h3>Import</h3>
      <%= form_with url: import_user_funds_path, local: true, multipart: true do |form| %>
        <div class="input-group input-group-lg">
          <div class="input-group-prepend">
            <button type="button" class="btn btn-import dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Broker
            </button>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="#">SBI SECURITIES CO.,Ltd.</a>
            </div>
          </div>
          <%= text_field_tag 'file_name', '', class: 'form-control',
                                              onclick: '$("#file").click();',
                                              :placeholder => 'Click here and choose CSV file.' %>
          <%= file_field_tag :file, style: 'display: none', onchange: 'file_selected($(this));' %>
          <div class="input-group-append">
            <%= submit_tag 'Import', id: 'submit', class: 'btn btn-import px-4',
                                                   data: { 'disable-with': 'Importing...' } %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% if @funds.present? %>
    <div class="row my-5">
      <div class="col-xs-12 col-sm-12">
        <h3 class="">Investments</h3>
        <table class="table small">
          <thead class="thead-light">
            <tr>
              <th width="8%" class="text-center">Account</th>
              <th width="44%" class="text-center">Name</th>
              <th width="9%" class="text-center">Purchase</th>
              <th width="9%" class="text-center">Valuation</th>
              <th width="9%" class="text-center">Difference</th>
              <th width="9%" class="text-center">Class</th>
              <th width="12%" class="text-center">Increase</th>
            </tr>
          </thead>
          <tbody>
            <% @funds.each do |fund| %>
              <tr>
                <td class="align-middle"><%= fund.account %></td>
                <td class="align-middle"><%= fund.name %></td>
                <td class="align-middle text-right"><%= fund.purchase.to_s(:delimited) %></td>
                <td class="align-middle text-right"><%= fund.valuation.to_s(:delimited) %></td>
                <td class="align-middle text-right<%= ' text-danger' if fund.difference < 0 %>">
                  <%= fund.difference.to_s(:delimited) %>
                </td>
                <td class="align-middle">
                  <%= select_tag 'category', options_for_select(@categories, { :selected => fund.category }),
                                               include_blank: true,
                                               class: 'custom-select custom-select-sm',
                                               data: { remote: true,
                                                       method: 'POST',
                                                       url: set_category_user_funds_path,
                                                       params: 'id=' + fund.id.to_s,
                                                       type: 'json' } %>
                </td>
                <td class="align-middle">
                  <%= number_field_tag 'increase', 0, class: 'form-control form-control-sm text-right',
                                                      value: fund.increase,
                                                      data: { remote: true,
                                                              method: 'POST',
                                                              url: set_increase_user_funds_path,
                                                              params: 'id=' + fund.id.to_s,
                                                              type: 'json' } %>
                </td>
              </tr>
            <% end %>
            <tr>
              <td></td>
              <td></td>
              <td class="text-right"><%= @sum['買付金額'].to_s(:delimited) %></td>
              <td class="text-right"><%= @sum['評価金額'].to_s(:delimited) %></td>
              <td class="text-right<%= ' text-danger' if @sum['評価損益'] < 0 %>">
                <%= @sum['評価損益'].to_s(:delimited) %>
              </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  
    <div class="row my-5">
      <div class="col-xs-12 col-sm-6">
        <h3>Ratio</h3>
        <table class="table small">
          <thead>
            <tr class="thead-light">
              <th width="5%" class="text-center">Class</th>
              <th width="19%" class="text-center">Purchase</th>
              <th width="19%" class="text-center">Valuation</th>
              <th width="19%" class="text-center">Real</th>
              <th width="19%" class="text-center">Ideal</th>
              <th width="19%" class="text-center">Difference</th>
            </tr>
          </thead>
          <tbody>
            <% @assets.keys.each do |category| %>
              <tr>
                <td class="align-middle"><%= category %></td>
                <td class="align-middle text-right" id="買付金額_<%= category %>">
                  <%= @assets[category][:買付金額].to_s(:delimited) %>
                </td>
                <td class="align-middle text-right" id="評価金額_<%= category %>">
                  <%= @assets[category][:評価金額].to_s(:delimited) %>
                </td>
                <td class="align-middle text-right percent" id="実際比率_<%= category %>">
                  <%= @assets[category][:実際比率] %>
                </td>
                <td class="align-middle text-right">
                  <%= number_field_tag 'ratio', 0, class: 'form-control form-control-sm text-right',
                                                   id: '目標比率_' + category,
                                                   value: @assets[category][:目標比率],
                                                   step: 0.1,
                                                   data: { remote: true,
                                                           method: 'POST',
                                                           url: set_ratio_user_funds_path,
                                                           params: 'category=' + category,
                                                           type: 'json' } %>
                </td>
                <td class="align-middle text-right percent<%= ' text-danger' if @assets[category][:比率差分] < 0 %>" id="比率差分_<%= category %>">
                  <%= @assets[category][:比率差分] %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="col-xs-12 col-sm-3 pt-5 pl-5">
        <h4>Real</h4>
        <%= pie_chart @real, id: 'real-ratio',
                             colors: @colors,
                             legend: 'bottom',
                             width: '80%',
                             donut: true,
                             suffix: '%' %>
      </div>
      <div class="col-xs-12 col-sm-3 pt-5 pl-5">
        <h4>Ideal</h4>
        <%= pie_chart @ideal, id: 'ideal-ratio',
                              colors: @colors,
                              legend: 'bottom',
                              width: '80%',
                              donut: true,
                              suffix: '%' %>
      </div>

    </div>
  <% end %>

</div>

<script>
  document.body.addEventListener('ajax:success', function(event) {
    var data = event.detail[0];

    switch (data.event) {
      case 'Category':
        if (data.before.category) {
          document.querySelector('#買付金額_' + data.before.category).innerText = data.before.purchase;
          document.querySelector('#評価金額_' + data.before.category).innerText = data.before.valuation;
          document.querySelector('#実際比率_' + data.before.category).innerText = data.before.real + ' ';
          document.querySelector('#比率差分_' + data.before.category).innerText = data.before.diff + ' ';
          if (data.before.diff < 0) {
            document.querySelector('#比率差分_' + data.before.category).classList.add('text-danger');
          } else {
            document.querySelector('#比率差分_' + data.before.category).classList.remove('text-danger');
          }
        }

        document.querySelector('#買付金額_' + data.after.category).innerText = data.after.purchase;
        document.querySelector('#評価金額_' + data.after.category).innerText = data.after.valuation;
        document.querySelector('#実際比率_' + data.after.category).innerText = data.after.real + ' ';
        document.querySelector('#比率差分_' + data.after.category).innerText = data.after.diff + ' ';
        if (data.after.diff < 0) {
          document.querySelector('#比率差分_' + data.after.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.after.category).classList.remove('text-danger');
        }
  
        var real_chart = Chartkick.charts['real-ratio'];
        real_chart.updateData(data.ratio.real);
        var ideal_chart = Chartkick.charts['ideal-ratio'];
        ideal_chart.updateData(data.ratio.ideal);
        break;

      case 'Increase':
        document.querySelector('#評価金額_' + data.before.category).innerText = data.before.valuation;
        document.querySelector('#実際比率_' + data.before.category).innerText = data.before.real + ' ';
        document.querySelector('#比率差分_' + data.before.category).innerText = data.before.diff + ' ';
        if (data.before.diff < 0) {
          document.querySelector('#比率差分_' + data.before.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.before.category).classList.remove('text-danger');
        }
  
        var real_chart = Chartkick.charts['real-ratio'];
        real_chart.updateData(data.ratio.real);
        break;

      case 'Ratio':
        var diff = $('#実際比率_' + data.category).text().trim() - data.value;
        document.querySelector('#目標比率_' + data.category).value = parseInt(data.value).toFixed(1);
        document.querySelector('#比率差分_' + data.category).innerText = diff.toFixed(3) + ' ';
        var diff = $('#実際比率_' + data.category).text().trim() - data.value;
        if (diff < 0) {
          document.querySelector('#比率差分_' + data.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.category).classList.remove('text-danger');
        }
  
        var chart = Chartkick.charts['ideal-ratio'];
        chart.updateData(data.ideal);
        break;

      default:
        break;
    }
  });

  $('#submit').on('click', function() {
    if ($('#file_name').val() == '') {
      alert('Nothing selected a CSV file.');
      $('#file_name').focus();
      return false;
    }
  });

  function file_selected(file_field) {
    var file_name = $(file_field)[0].files[0].name;
    $('#file_name').val(file_name);
  }
</script>