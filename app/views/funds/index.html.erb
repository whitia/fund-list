<% provide :title, 'Organization' %>
<div class="container">
  <h2 class="mt-5">Organization</h2>
  <div class="font-weight-light">
    <p>
      You can organize your investments for SBI SECURITIES Co.,Ltd. in Organization, following next section and let's beginning.<br />
      Do you necessary more help? You may be able to find solution in <%= link_to 'Help', help_path %>.
    </p>
    <ol>
      <li>Import CSV file of your investments.</li>
      <li>Choose "Class" of assets from dropdown list.</li>
      <li>Look real ratios to chart or pie.</li>
      <li>Input "Ideal" ratios on textbox.</li>
      <li>Input "Increase" on textbox if increase an investment.</li>
    </ol>
  </div>

  <div class="row my-5">
    <div class="col-xs-12 col-sm-12">
      <h3>Import</h3>
      <%= form_with url: import_user_funds_path, local: true, multipart: true do |form| %>
        <div class="input-group input-group-lg">
          <%= text_field_tag 'file_name', '', class: 'form-control',
                                              onclick: '$("#file").click();',
                                              :placeholder => 'Click here and choose CSV file.' %>
          <%= file_field_tag :file, style: 'display: none', onchange: 'file_selected($(this));' %>
          <div class="input-group-append">
            <%= submit_tag 'Import', id: 'submit', class: 'btn btn-import px-4' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% if @funds.present? %>
    <div class="row my-5">
      <div class="col-xs-12 col-sm-12">
        <h3 class="">Investments</h3>
        <table class="table small">
          <thead class="thead-light">
            <tr>
              <th width="8%" class="text-center">Account</th>
              <th width="44%" class="text-center">Name</th>
              <th width="9%" class="text-center">Purchase</th>
              <th width="9%" class="text-center">Valuation</th>
              <th width="9%" class="text-center">Difference</th>
              <th width="9%" class="text-center">Class</th>
              <th width="12%" class="text-center">Increase</th>
            </tr>
          </thead>
          <tbody>
            <% @funds.each do |fund| %>
              <tr>
                <td class="align-middle"><%= fund.account %></td>
                <td class="align-middle"><%= fund.name %></td>
                <td class="align-middle text-right"><%= fund.purchase.to_s(:delimited) %></td>
                <td class="align-middle text-right"><%= fund.valuation.to_s(:delimited) %></td>
                <td class="align-middle text-right<%= ' text-danger' if fund.difference < 0 %>">
                  <%= fund.difference.to_s(:delimited) %>
                </td>
                <td class="align-middle">
                  <%= select_tag 'categories', options_for_select(@categories, { :selected => fund.category }),
                                               include_blank: true,
                                               class: 'custom-select custom-select-sm',
                                               data: { category_id: fund.id },
                                               onchange: 'set_category($(this));' %>
                </td>
                <td class="align-middle">
                  <%= number_field_tag 'increase', 0, class: 'form-control form-control-sm text-right',
                                                      value: fund.increase,
                                                      data: { category_id: fund.id },
                                                      onchange: 'set_increase($(this));' %>
                </td>
              </tr>
            <% end %>
            <tr>
              <td></td>
              <td></td>
              <td class="text-right"><%= @sum['買付金額'].to_s(:delimited) %></td>
              <td class="text-right"><%= @sum['評価金額'].to_s(:delimited) %></td>
              <td class="text-right<%= ' text-danger' if @sum['評価損益'] < 0 %>">
                <%= @sum['評価損益'].to_s(:delimited) %>
              </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  
    <div class="row my-5">
      <div class="col-xs-12 col-sm-6">
        <h3>Ratio</h3>
        <table class="table small">
          <thead>
            <tr class="thead-light">
              <th width="5%" class="text-center">Class</th>
              <th width="19%" class="text-center">Purchase</th>
              <th width="19%" class="text-center">Valuation</th>
              <th width="19%" class="text-center">Real</th>
              <th width="19%" class="text-center">Ideal</th>
              <th width="19%" class="text-center">Difference</th>
            </tr>
          </thead>
          <tbody>
            <% @assets.keys.each do |category| %>
              <tr>
                <td class="align-middle"><%= category %></td>
                <td class="align-middle text-right" id="買付金額_<%= category %>">
                  <%= @assets[category][:買付金額].to_s(:delimited) %>
                </td>
                <td class="align-middle text-right" id="評価金額_<%= category %>">
                  <%= @assets[category][:評価金額].to_s(:delimited) %>
                </td>
                <td class="align-middle text-right percent" id="実際比率_<%= category %>">
                  <%= @assets[category][:実際比率] %>
                </td>
                <td class="align-middle text-right">
                  <%= number_field_tag 'ratio', 0, class: 'form-control form-control-sm text-right',
                                                   id: '目標比率_' + category,
                                                   value: @assets[category][:目標比率],
                                                   step: 0.1,
                                                   data: { category: category },
                                                   onchange: 'set_ratio($(this));' %>
                </td>
                <td class="align-middle text-right percent<%= ' text-danger' if @assets[category][:比率差分] < 0 %>" id="比率差分_<%= category %>">
                  <%= @assets[category][:比率差分] %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="col-xs-12 col-sm-3 pt-5 pl-5">
        <h4>Real</h4>
        <%= pie_chart @real, id: 'real-ratio',
                             colors: @colors,
                             legend: 'bottom',
                             width: '80%',
                             donut: true,
                             suffix: '%' %>
      </div>
      <div class="col-xs-12 col-sm-3 pt-5 pl-5">
        <h4>Ideal</h4>
        <%= pie_chart @ideal, id: 'ideal-ratio',
                              colors: @colors,
                              legend: 'bottom',
                              width: '80%',
                              donut: true,
                              suffix: '%' %>
      </div>

    </div>
  <% end %>

</div>

<script>
  // $(function () {
  //   $(document).ajaxSuccess(function(event, xhr, settings) {
  //     xhr.responseJSON.category;
  //   });
  // });

  $('#submit').on('click', function() {
    if ($('#file_name').val() == '') {
      alert('ファイルを選択してください');
      $('#file_name').focus();
      return false;
    }
  });

  function file_selected(file_field) {
    var file_name = $(file_field)[0].files[0].name;
    $('#file_name').val(file_name);
  }

  function set_category(selected) {
    var category = selected[0].selectedOptions[0].value;
    $.ajax({
      type: 'POST',
      url: '<%= set_category_user_funds_path %>',
      data: {
        id: selected.data('category-id'),
        category: category
      },
      dataType: 'json'
    })
    .done(function(data, stat, xhr) {
      $('#買付金額_' + data.before.category).text(data.before.purchase);
      $('#評価金額_' + data.before.category).text(data.before.valuation);
      $('#実際比率_' + data.before.category).text(data.before.real + ' ');
      $('#比率差分_' + data.before.category).text(data.before.diff + ' ');
      if (data.before.diff < 0) {
        $('#比率差分_' + data.before.category).addClass('text-danger');
      } else {
        $('#比率差分_' + data.before.category).removeClass('text-danger');
      }

      $('#買付金額_' + data.after.category).text(data.after.purchase);
      $('#評価金額_' + data.after.category).text(data.after.valuation);
      $('#実際比率_' + data.after.category).text(data.after.real + ' ');
      $('#比率差分_' + data.after.category).text(data.after.diff + ' ');
      if (data.after.diff < 0) {
        $('#比率差分_' + data.after.category).addClass('text-danger');
      } else {
        $('#比率差分_' + data.after.category).removeClass('text-danger');
      }
    })
    .fail(function(xhr, stat, err) {
      alert(err);
    });
  }

  function set_increase(input) {
    $.ajax({
      type: 'POST',
      url: '<%= set_increase_user_funds_path %>',
      data: {
        id: input.data('category-id'),
        increase: input.val()
      },
      dataType: 'json'
    })
    .done(function(data, stat, xhr) {
      $('#評価金額_' + data.before.category).text(data.before.valuation);
      $('#実際比率_' + data.before.category).text(data.before.real + ' ');
      $('#比率差分_' + data.before.category).text(data.before.diff + ' ');
      if (data.before.diff < 0) {
        $('#比率差分_' + data.before.category).addClass('text-danger');
      } else {
        $('#比率差分_' + data.before.category).removeClass('text-danger');
      }
    })
    .fail(function(xhr, stat, err) {
      alert(err);
    });
  }

  function set_ratio(input) {
    $.ajax({
      type: 'POST',
      url: '<%= set_ratio_user_funds_path %>',
      data: {
        category: input.data('category'),
        value: input[0].value
      },
      dataType: 'json'
    })
    .done(function(data, stat, xhr) {
      diff = $('#実際比率_' + data.category).text().trim() - data.value;
      $('#目標比率_' + data.category).val(parseInt(data.value).toFixed(1));
      $('#比率差分_' + data.category).text(diff.toFixed(3) + ' ');
      if (diff < 0) {
        $('#比率差分_' + data.category).addClass('text-danger');
      } else {
        $('#比率差分_' + data.category).removeClass('text-danger');
      }
    })
    .fail(function(xhr, stat, err) {
      alert(err);
    });
  }

</script>