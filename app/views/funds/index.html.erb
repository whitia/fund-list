<% provide :title, '投資信託' %>
<div class="container py-5">
  <h2 class="font-weight-light">投資信託</h2>
  <div class="font-weight-light">
    <p>
      あなたの保有する投資信託をかんたんな操作だけできれいに整理できます。下記の手順に従ってはじめましょう。<br />
      さらに助けが必要ですか？ <%= link_to 'ヘルプ', help_path %>で解決策が見つかるかもしれません。
    </p>
    <ol>
      <li>SBI証券からダウンロードした投資信託のCSVファイルをインポートします。</li>
      <li>投資信託一覧から各投資信託のクラスをリストから選択します。</li>
      <li>表、または円グラフで投資信託の比率が確認できます。</li>
      <li>比率から各クラスの目標比率を入力します。</li>
      <li>増資金額を入力することで、リバランスのシミュレーションができます。</li>
    </ol>
  </div>

  <div class="row my-5">
    <div class="col-12 col-sm-12">
      <h3 class="font-weight-light">インポート</h3>
      <%= form_with url: import_user_funds_path, local: true, multipart: true do |form| %>
        <div class="input-group input-group-lg">
          <%= text_field_tag 'file_name', '', class: 'form-control',
                                              onclick: '$("#file").click();',
                                              placeholder: 'ここをクリックしてCSVファイルを選択してください' %>
          <%= file_field_tag :file, style: 'display: none', onchange: 'file_selected($(this));' %>
          <div class="input-group-append">
            <%= submit_tag 'Import', id: 'submit', class: 'btn btn-dark px-4',
                                                   data: { 'disable-with': 'Importing...' } %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% if @funds.present? %>
    <div class="row my-5">
      <div class="col-12 col-sm-12">
        <h3 class="font-weight-light">投資信託一覧</h3>
        <table class="table small">
          <thead class="thead-light">
            <tr>
              <th width="10%" class="text-center">種別</th>
              <th width="50%" class="text-center">名称</th>
              <th width="10%" class="text-center">購入金額</th>
              <th width="10%" class="text-center">評価金額</th>
              <th width="10%" class="text-center">評価損益</th>
              <th width="10%" class="text-center">クラス</th>
            </tr>
          </thead>
          <tbody>
            <% @funds.each do |fund| %>
              <tr>
                <td class="align-middle"><%= fund.account %></td>
                <td class="align-middle"><%= fund.name %></td>
                <td class="align-middle text-right"><%= fund.purchase.to_s(:delimited) %></td>
                <td class="align-middle text-right"><%= fund.valuation.to_s(:delimited) %></td>
                <td class="align-middle text-right<%= ' text-danger' if fund.difference < 0 %>">
                  <%= fund.difference.to_s(:delimited) %>
                </td>
                <td class="align-middle">
                  <%= select_tag 'category', options_for_select(@categories, { :selected => fund.category }),
                                               include_blank: true,
                                               class: 'custom-select custom-select-sm',
                                               data: { remote: true,
                                                       method: 'POST',
                                                       url: set_category_user_funds_path,
                                                       params: 'id=' + fund.id.to_s,
                                                       type: 'json' } %>
                </td>
              </tr>
            <% end %>
            <tr>
              <td></td>
              <td></td>
              <td class="text-right"><%= @sum['買付金額'].to_s(:delimited) %></td>
              <td class="text-right"><%= @sum['評価金額'].to_s(:delimited) %></td>
              <td class="text-right<%= ' text-danger' if @sum['評価損益'] < 0 %>">
                <%= @sum['評価損益'].to_s(:delimited) %>
              </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  
    <div class="row my-5">
      <div class="col-12 col-sm-8">
        <h3 class="font-weight-light">比率</h3>
        <table class="table small">
          <thead>
            <tr class="thead-light">
              <th width="10%" class="text-center">クラス</th>
              <th width="15%" class="text-center">購入金額</th>
              <th width="15%" class="text-center">評価金額</th>
              <th width="15%" class="text-center">増資金額</th>
              <th width="15%" class="text-center">実際比率</th>
              <th width="15%" class="text-center">目標比率</th>
              <th width="15%" class="text-center">比率差分</th>
            </tr>
          </thead>
          <tbody>
            <% @assets.keys.each do |category| %>
              <tr>
                <td class="align-middle"><%= category %></td>
                <td class="align-middle text-right" id="買付金額_<%= category %>">
                  <%= @assets[category][:買付金額].to_s(:delimited) %>
                </td>
                <td class="align-middle text-right" id="評価金額_<%= category %>">
                  <%= @assets[category][:評価金額].to_s(:delimited) %>
                </td>
                <td class="align-middle">
                  <%= number_field_tag 'increase', 0, class: 'form-control form-control-sm text-right',
                                                      value: @assets[category][:増資額],
                                                      data: { remote: true,
                                                              method: 'POST',
                                                              url: set_increase_user_funds_path,
                                                              params: 'category=' + category,
                                                              type: 'json' } %>
                </td>
                <td class="align-middle text-right percent" id="実際比率_<%= category %>">
                  <%= @assets[category][:実際比率] %>
                </td>
                <td class="align-middle text-right">
                  <%= number_field_tag 'ratio', 0, class: 'form-control form-control-sm text-right',
                                                   id: '目標比率_' + category,
                                                   value: @assets[category][:目標比率],
                                                   step: 0.1,
                                                   data: { remote: true,
                                                           method: 'POST',
                                                           url: set_ratio_user_funds_path,
                                                           params: 'category=' + category,
                                                           type: 'json' } %>
                </td>
                <td class="align-middle text-right percent<%= ' text-danger' if @assets[category][:比率差分] < 0 %>" id="比率差分_<%= category %>">
                  <%= @assets[category][:比率差分] %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="col-12 col-sm-4">
        <h4 class="font-weight-light">実際比率</h4>
        <%= pie_chart @real, id: 'real-ratio',
                             colors: @colors,
                             legend: 'bottom',
                             width: '80%',
                             donut: true,
                             suffix: '%' %>
        <br />
        <h4 class="font-weight-light">目標比率</h4>
        <%= pie_chart @ideal, id: 'ideal-ratio',
                              colors: @colors,
                              legend: 'bottom',
                              width: '80%',
                              donut: true,
                              suffix: '%' %>
      </div>

    </div>
  <% end %>

</div>

<script>
  document.body.addEventListener('ajax:success', function(event) {
    var data = event.detail[0];

    switch (data.event) {
      case 'Category':
        if (data.before.category) {
          document.querySelector('#買付金額_' + data.before.category).innerText = data.before.purchase;
          document.querySelector('#評価金額_' + data.before.category).innerText = data.before.valuation;
          document.querySelector('#実際比率_' + data.before.category).innerText = data.before.real + ' ';
          document.querySelector('#比率差分_' + data.before.category).innerText = data.before.diff + ' ';
          if (data.before.diff < 0) {
            document.querySelector('#比率差分_' + data.before.category).classList.add('text-danger');
          } else {
            document.querySelector('#比率差分_' + data.before.category).classList.remove('text-danger');
          }
        }

        document.querySelector('#買付金額_' + data.after.category).innerText = data.after.purchase;
        document.querySelector('#評価金額_' + data.after.category).innerText = data.after.valuation;
        document.querySelector('#実際比率_' + data.after.category).innerText = data.after.real + ' ';
        document.querySelector('#比率差分_' + data.after.category).innerText = data.after.diff + ' ';
        if (data.after.diff < 0) {
          document.querySelector('#比率差分_' + data.after.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.after.category).classList.remove('text-danger');
        }
  
        var real_chart = Chartkick.charts['real-ratio'];
        real_chart.updateData(data.ratio.real);
        var ideal_chart = Chartkick.charts['ideal-ratio'];
        ideal_chart.updateData(data.ratio.ideal);
        break;

      case 'Increase':
        document.querySelector('#評価金額_' + data.before.category).innerText = data.before.valuation;
        document.querySelector('#実際比率_' + data.before.category).innerText = data.before.real + ' ';
        document.querySelector('#比率差分_' + data.before.category).innerText = data.before.diff + ' ';
        if (data.before.diff < 0) {
          document.querySelector('#比率差分_' + data.before.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.before.category).classList.remove('text-danger');
        }
  
        var real_chart = Chartkick.charts['real-ratio'];
        real_chart.updateData(data.ratio.real);
        break;

      case 'Ratio':
        var diff = $('#実際比率_' + data.category).text().trim() - data.value;
        document.querySelector('#目標比率_' + data.category).value = parseInt(data.value).toFixed(1);
        document.querySelector('#比率差分_' + data.category).innerText = diff.toFixed(3) + ' ';
        var diff = $('#実際比率_' + data.category).text().trim() - data.value;
        if (diff < 0) {
          document.querySelector('#比率差分_' + data.category).classList.add('text-danger');
        } else {
          document.querySelector('#比率差分_' + data.category).classList.remove('text-danger');
        }
  
        var chart = Chartkick.charts['ideal-ratio'];
        chart.updateData(data.ideal);
        break;

      default:
        break;
    }
  });

  $('#submit').on('click', function() {
    if ($('#file_name').val() == '') {
      alert('Nothing selected a CSV file.');
      $('#file_name').focus();
      return false;
    }
  });

  function file_selected(file_field) {
    var file_name = $(file_field)[0].files[0].name;
    $('#file_name').val(file_name);
  }
</script>